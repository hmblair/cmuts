#!/bin/bash

print-usage() {
  echo "Usage: $(basename $0) {align|core|normalize|pairwise|visualize|test}"
}

case "$1" in
  -h|--help)
    print-usage
    exit 0
    ;;
  -v|--version)
    DIR=$(dirname $(which cmuts))
    VERSION=$(cat "$DIR/VERSION")
    echo "cmuts version $VERSION"
    exit 0
    ;;
  align)
    cmuts-align "${@:2}"
    ;;
  core)
    threads=""
    new_args=()
    skip_next=false
    for arg in "${@:2}"; do
      if [ "$skip_next" = true ]; then
        threads="$arg"
        skip_next=false
      elif [ "$arg" = "--threads" ]; then
        skip_next=true
      else
        new_args+=("$arg")
      fi
    done
    # Run with mpirun if threads specified, otherwise run normally
    if [ -n "$threads" ]; then
      if ! cmuts core --version 2>/dev/null | grep -q "MPI"; then
        if [[ $threads == 1 ]]; then
          cmuts-core "${new_args[@]}"
        else
          echo "cmuts not built with MPI, --threads > 1 cannot be used"
          exit 1
        fi
      else
        mpirun -np "$threads" cmuts-core "${new_args[@]}"
      fi
    else
      cmuts-core "${@:2}"
    fi
    ;;
  normalize)
    cmuts-normalize "${@:2}"
    ;;
  pairwise)
    cmuts-pairwise "${@:2}"
    ;;
  visualize)
    cmuts-visualize "${@:2}"
    ;;
  test)
    cmuts-test "${@:2}"
    ;;
  *)
    print-usage
    exit 1
    ;;
esac
