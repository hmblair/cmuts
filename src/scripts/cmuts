#!/bin/bash

set -eou pipefail

print-usage() {
  echo "Usage: $(basename "$0") [--log LOGFILE] {align|core|generate|normalize|plot|visualize|test}"
  echo ""
  echo "Test options:"
  echo "  test              Run pytest integration tests"
  echo "  test --quick      Run quick tests only (skip slow/stress tests)"
  echo "  test --cram       Run CRAM-specific tests only"
}

export _CMUTS_DIR="$(dirname "$(dirname "$(which cmuts)")")"
export _CMUTS_VERSION="$(git -C "$_CMUTS_DIR" describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "unknown")"

# Parse --log argument
LOG=""
args=()
skip_next=false

for arg in "$@"; do
  if [ "$skip_next" = true ]; then
    LOG="$arg"
    skip_next=false
  elif [ "$arg" = "--log" ]; then
    skip_next=true
  else
    args+=("$arg")
  fi
done

if [ -n "$LOG" ]; then
  exec >> "$LOG" 2>&1
fi

case "${args[0]:-}" in
  -h|--help)
    print-usage
    exit 0
    ;;
  -v|--version)
    echo "cmuts v$_CMUTS_VERSION"
    exit 0
    ;;
  align)
    cmuts-align "${args[@]:1}"
    ;;
  core)
    threads=""
    new_args=()
    skip_next=false
    for arg in "${args[@]:1}"; do
      if [ "$skip_next" = true ]; then
        threads="$arg"
        skip_next=false
      elif [ "$arg" = "--threads" ]; then
        skip_next=true
      else
        new_args+=("$arg")
      fi
    done
    # Validate threads value
    if [ -n "$threads" ]; then
      if ! [[ "$threads" =~ ^[1-9][0-9]*$ ]]; then
        echo "Error: --threads must be a positive integer, got '$threads'" >&2
        exit 1
      fi
    fi
    # Run with mpirun if threads > 1, otherwise run directly
    if [ -n "$threads" ] && [[ "$threads" -gt 1 ]]; then
      if ! cmuts-core --version 2>/dev/null | grep -q "MPI"; then
        echo "Error: cmuts was not built with MPI support, --threads > 1 cannot be used" >&2
        exit 1
      fi
      if ! command -v mpirun &>/dev/null; then
        echo "Error: mpirun not found, but cmuts was built with MPI support" >&2
        exit 1
      fi
      mpirun -np "$threads" cmuts-core "${new_args[@]}"
    elif [ -n "$threads" ]; then
      cmuts-core "${new_args[@]}"
    else
      cmuts-core "${args[@]:1}"
    fi
    ;;
  normalize)
    cmuts-normalize "${args[@]:1}"
    ;;
  plot)
    cmuts-plot "${args[@]:1}"
    ;;
  visualize)
    cmuts-visualize "${args[@]:1}"
    ;;
  test)
    # Run pytest tests
    pytest_args=("-v" "--tb=short")
    # Pass through any additional args (e.g., -k, --quick)
    for arg in "${args[@]:1}"; do
      case "$arg" in
        --quick)
          pytest_args+=("-m" "not slow")
          ;;
        --cram)
          pytest_args+=("-k" "cram")
          ;;
        *)
          pytest_args+=("$arg")
          ;;
      esac
    done
    python3 -m pytest "$_CMUTS_DIR/tests/python" "${pytest_args[@]}"
    ;;
  generate)
    cmuts-generate "${args[@]:1}"
    ;;
  *)
    print-usage
    exit 1
    ;;
esac
