#!/bin/bash

set -eou pipefail

BAM=false
CRAM=false
OUTPUT=""
FASTA=""
ARGS=()

while [[ "$#" -gt 0 ]]; do
  case "$1" in
    --bam)
      BAM=true
      ;;
    --cram)
      CRAM=true
      ;;
    -o|--out)
      shift
      OUTPUT="$1"
      ;;
    --out-fasta)
      shift
      FASTA="$1"
      ARGS+=("--out-fasta" "$1")
      ;;
    *)
      ARGS+=("$1")
      ;;
  esac
  shift
done

if [[ -z "$OUTPUT" ]]; then
  echo "Error: -o/--out is required." >&2
  exit 1
fi

if [[ "$BAM" == "false" && "$CRAM" == "false" ]]; then
  _cmuts-generate-tests -o "$OUTPUT" "${ARGS[@]}"
  exit 0
fi

if [[ -z "$FASTA" ]]; then
  echo "Error: --out-fasta is required when using --bam or --cram." >&2
  exit 1
fi

# Strip any .sam/.bam/.cram extension to get a base name
DIR="$(dirname "$OUTPUT")"
FILENAME="$(basename "$OUTPUT")"
BASE="${DIR}/${FILENAME%.*}"

SAM_TMP="$(mktemp "${BASE}.XXXXXX.sam")"
BAM_TMP="$(mktemp "${BASE}.XXXXXX.bam")"
trap 'rm -f "$SAM_TMP" "$BAM_TMP"' EXIT

_cmuts-generate-tests -o "$SAM_TMP" "${ARGS[@]}"

if [[ "$BAM" == "true" ]]; then
  samtools calmd -b "$SAM_TMP" "$FASTA" 2>/dev/null > "$BAM_TMP"
  samtools sort -o "${BASE}.bam" "$BAM_TMP"
fi

if [[ "$CRAM" == "true" ]]; then
  samtools sort -o "$BAM_TMP" "$SAM_TMP"
  samtools view -T "$FASTA" -C --output-fmt-option version=3.0 -o "${BASE}.cram" "$BAM_TMP"
fi
