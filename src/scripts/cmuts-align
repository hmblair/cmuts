#!/bin/bash

set -eou pipefail

FASTA=""
OUTPUT=""
THREADS="1"
FILES=()

while [[ "$#" -gt 0 ]]; do
    case "$1" in
        --fasta)
            shift
            FASTA="$1"
            ;;
        --output)
            shift
            OUTPUT="$1"
            ;;
        --threads)
            shift
            THREADS="$1"
            ;;
        *)
            FILES+=("$1")
            ;;
    esac
    shift
done

if [[ -z "$FASTA" || -z "$OUTPUT" || "${#FILES[@]}" -eq 0 ]]; then
  echo "Usage: cmuts-align --fasta FASTA --output OUTPUT [FILES ...]"
  exit 1
fi

# Convert to DNA before processing

sed '/^>/!s/U/T/g' "$FASTA" > "${FASTA%.*}-T.${FASTA##*.}"
FASTA="${FASTA%.*}-T.${FASTA##*.}"

INDEX="index/index"
TMPDIR=".tmp"
mkdir -p index "$TMPDIR" "$OUTPUT"
bowtie2-build --threads "$THREADS" "$FASTA" "$INDEX" >> "cmuts-align.log" 2>&1

for FILE in "${FILES[@]}"; do

  NAME=$(basename "$FILE")
  BASENAME="${NAME%.*}"

  TMP="${TMPDIR}/${BASENAME}_UNSORTED.sam"
  FINAL="${OUTPUT}/${BASENAME}.bam"

  echo >> "cmuts-align.log"
  echo " -- Aligning $NAME --" >> "cmuts-align.log"
  echo >> "cmuts-align.log"

  bowtie2 \
    --threads "$THREADS" \
    -x "$INDEX" \
    --dpad 30 \
    --maxins=800 \
    --ignore-quals \
    --local \
    --mp 3,1 \
    --rdg 5,1 \
    --rfg 5,1 \
    "$FILE" > "$TMP" 2>> "cmuts-align.log"

  echo >> "cmuts-align.log"
  echo " -- Sorting $NAME --" >> "cmuts-align.log"
  echo >> "cmuts-align.log"

  samtools sort --threads "$THREADS" -o "$FINAL" "$TMP"

done

rm -rf "$TMPDIR"
