#!/bin/bash

set -eou pipefail

# =============================================================================
# Utility Functions
# =============================================================================

rand() {
    local min=$1 max=$2
    echo $((RANDOM % (max - min + 1) + min))
}

get_max_threads() {
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        nproc
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        sysctl -n hw.ncpu
    else
        echo 1
    fi
}

# =============================================================================
# Argument Parsing
# =============================================================================

USE_CRAM=0
USE_RF=0
KEEP_TMP=0

while [[ "$#" -gt 0 ]]; do
    case $1 in
        --cram)     USE_CRAM=1 ;;
        --rf-count) USE_RF=1 ;;
        --keep-tmp) KEEP_TMP=1 ;;
        *)          echo "Unknown option: $1"; exit 1 ;;
    esac
    shift
done

# =============================================================================
# Working Directory Setup
# =============================================================================

SCRIPT_DIR=$(pwd)
WORK_DIR="${SCRIPT_DIR}/.cmuts-test"

rm -rf "${WORK_DIR}"
mkdir -p "${WORK_DIR}"
pushd "${WORK_DIR}" > /dev/null

cleanup() {
    popd > /dev/null
    if [[ $KEEP_TMP -eq 0 ]]; then
        rm -rf "$WORK_DIR"
    fi
}
trap cleanup EXIT

# =============================================================================
# Test Parameters
# =============================================================================

# Reference and query counts
LENGTH=$(rand 2 250)
QUERIES=$(rand 1 1024)
REFERENCES=$(rand 1 64)

# Threading
if cmuts core --version 2>/dev/null | grep -q "MPI"; then
    THREADS=$(rand 1 "$(get_max_threads)")
else
    THREADS=1
fi
CHUNKSIZE=$(rand 1 256)

# Quality filters
MIN_MAPQ=$(rand 0 30)
MIN_PHRED=$(rand 0 10)
WINDOW=$(rand 0 "${LENGTH}")

# Length filters
MIN_LENGTH=$(rand 2 "${LENGTH}")
MAX_LENGTH=$(rand "${LENGTH}" $((2 * LENGTH)))
MAX_INDEL=$(rand 0 "${LENGTH}")

# Collapse distance
COLLAPSE=$(rand 0 "${LENGTH}")

# Boolean flags (20% chance of being enabled)
NO_MISMATCHES=$([[ $(rand 0 4) -eq 4 ]] && echo 1 || echo 0)
NO_INSERTIONS=$([[ $(rand 0 4) -eq 4 ]] && echo 1 || echo 0)
NO_DELETIONS=$([[ $(rand 0 4) -eq 4 ]] && echo 1 || echo 0)

# rf-count compatibility overrides
if [[ $USE_RF -eq 1 ]]; then
    WINDOW=1
    MAX_LENGTH=$((2 * LENGTH + 1))
    NO_MISMATCHES=0
    NO_INSERTIONS=1
fi

# =============================================================================
# File Paths
# =============================================================================

FASTA="seq.fasta"
SAM="aln.sam"
BAM_TMP="aln_tmp.bam"
EXP_H5="expected.h5"
CMUTS_H5="cmuts.h5"

if [[ $USE_CRAM -eq 1 ]]; then
    ALN_FILE="aln.cram"
else
    ALN_FILE="aln.bam"
fi

# =============================================================================
# Print Parameters
# =============================================================================

bool_to_str() { [[ $1 -eq 1 ]] && echo "TRUE" || echo "FALSE"; }

print_params() {
    echo ""
    echo "        TEST PARAMETERS"
    echo " ─────────────────────────────"
    echo "   CRAM:             $(bool_to_str $USE_CRAM)"
    echo "   THREADS:          $THREADS"
    echo "   CHUNK SIZE:       $CHUNKSIZE"
    echo "   REFERENCE LENGTH: $LENGTH"
    echo "   REFERENCES:       $REFERENCES"
    echo "   QUERIES:          $QUERIES"
    echo "   MIN LENGTH:       $MIN_LENGTH"
    echo "   MAX LENGTH:       $MAX_LENGTH"
    echo "   MAX INDEL LENGTH: $MAX_INDEL"
    echo "   MIN MAPQ:         $MIN_MAPQ"
    echo "   MIN PHRED:        $MIN_PHRED"
    echo "   QUALITY WINDOW:   $WINDOW"
    echo "   COLLAPSE DIST:    $COLLAPSE"
    echo "   NO MISMATCHES:    $(bool_to_str $NO_MISMATCHES)"
    echo "   NO INSERTIONS:    $(bool_to_str $NO_INSERTIONS)"
    echo "   NO DELETIONS:     $(bool_to_str $NO_DELETIONS)"
    echo " ─────────────────────────────"
}

# =============================================================================
# Test Execution Functions
# =============================================================================

generate_test_data() {
    local args=(
        --length "${LENGTH}"
        --queries "${QUERIES}"
        --references "${REFERENCES}"
        --out-fasta "${FASTA}"
        --out-sam "${SAM}"
        --out-h5 "${EXP_H5}"
        --min-mapq "${MIN_MAPQ}"
        --min-phred "${MIN_PHRED}"
        --min-length "${MIN_LENGTH}"
        --max-length "${MAX_LENGTH}"
        --max-indel-length "${MAX_INDEL}"
        --quality-window "${WINDOW}"
        --collapse "${COLLAPSE}"
    )

    [[ $NO_MISMATCHES -eq 1 ]] && args+=(--no-mismatches)
    [[ $NO_INSERTIONS -eq 1 ]] && args+=(--no-insertions)
    [[ $NO_DELETIONS -eq 1 ]]  && args+=(--no-deletions)

    cmuts-generate-tests "${args[@]}"
}

convert_alignment() {
    if [[ $USE_CRAM -eq 1 ]]; then
        samtools sort -@"${THREADS}" -o "${BAM_TMP}" "${SAM}" > /dev/null 2>&1
        samtools view -T "${FASTA}" -C --output-fmt-option version=3.0 -o "${ALN_FILE}" "${BAM_TMP}"
    else
        samtools calmd -b -@"${THREADS}" "${SAM}" "${FASTA}" > "${BAM_TMP}" 2> /dev/null
        samtools sort -@"${THREADS}" -o "${ALN_FILE}" "${BAM_TMP}" > /dev/null 2>&1
    fi
}

run_cmuts() {
    local args=(
        --threads "${THREADS}"
        --fasta "${FASTA}"
        --output "${CMUTS_H5}"
        --min-mapq "${MIN_MAPQ}"
        --min-phred "${MIN_PHRED}"
        --quality-window "${WINDOW}"
        --min-length "${MIN_LENGTH}"
        --max-length "${MAX_LENGTH}"
        --max-indel-length "${MAX_INDEL}"
        --collapse "${COLLAPSE}"
        --chunk-size "${CHUNKSIZE}"
        --disable-ambiguous
    )

    [[ $NO_MISMATCHES -eq 1 ]] && args+=(--no-mismatches)
    [[ $NO_INSERTIONS -eq 1 ]] && args+=(--no-insertions)
    [[ $NO_DELETIONS -eq 1 ]]  && args+=(--no-deletions)

    # Add new arguments here as needed

    cmuts core "${args[@]}" "${ALN_FILE}"
}

run_rf_count() {
    [[ $USE_RF -eq 0 ]] && return

    local args=(
        -wt "${THREADS}"
        -f "${FASTA}"
        -m
        --eval-surrounding
        --no-cov-low-qual
        --no-discard-duplicates
        --right-deletion
        --collapse-consecutive
        --max-collapse-distance $((COLLAPSE - 1))
        --max-edit-distance 1.0
        --map-quality "${MIN_MAPQ}"
        --min-quality "${MIN_PHRED}"
        --discard-shorter "${MIN_LENGTH}"
        --max-deletion-len "${MAX_INDEL}"
        --median-quality 0
    )

    [[ $NO_INSERTIONS -eq 1 ]] && args+=(--no-insertions)
    [[ $NO_DELETIONS -eq 1 ]]  && args+=(--no-deletions)

    rf-count "${args[@]}" "${ALN_FILE}"

    rf-rctools view rf_count/aln.rc | awk 'NR % 5 == 3' > rf_muts.txt
    rf-rctools view rf_count/aln.rc | awk 'NR % 5 == 4' > rf_cov.txt
}

# =============================================================================
# Main
# =============================================================================

print_params
generate_test_data
convert_alignment
run_cmuts
run_rf_count
cmuts-test-compare "${CMUTS_H5}" "${EXP_H5}" "${USE_RF}"
